name: Update Pull Request Label With Node.js

on:
  schedule:
    - cron: '0 9 * * *'  # ë§¤ì¼ ì•„ì¹¨ 9ì‹œ, UTC
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆëŠ” ì˜µì…˜

jobs:
  update-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install @octokit/rest
          npm install axios
          
      - name: Update labels with nodejs
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TEST_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node -e "
            const { Octokit } = require('@octokit/rest');
            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            
            (async () => {
              try {
                const { data: pulls } = await octokit.pulls.list({ owner, repo, state: 'open' });

                for (const pull of pulls) {
                  const labels = pull.labels.map(label => label.name);
                  const newLabels = labels.map(label => {
                    const match = label.match(/^D-(\\d+)$/);
                    if (match) {
                      const number = parseInt(match[1], 10);

                      if (number < 1) {
                        return \`:boom:\`;
                      }

                      return \`D-\${number - 1}\`;
                    }

                    return label;
                  });

                  await octokit.issues.update({
                    owner,
                    repo,
                    issue_number: pull.number,
                    labels: newLabels,
                  });
                }
              } catch (error) {
                console.error(\`Error updating labels: \${error.message}\`);
              }
            })();
          "
          
      - name: Send Slack notifications
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TEST_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SLACK_WEBHOOK_URL: ${{ secrets.ACTIONS_TEST_SLACK_WEBHOOK_URL }}
        run: |
          node -e "
            const axios = require('axios');
            const { Octokit } = require('@octokit/rest');
            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            
            (async () => {
              try {
                const { data: pulls } = await octokit.pulls.list({ owner, repo, state: 'open' });
                const labelMap = new Map();
                const prList = [];

                for (const pull of pulls) {
                  pull.labels.forEach(label => {
                    const match = label.name.match(/^D-(\\d+)$/);

                    if (!match && label.name != ':boom:') {
                      return;
                    }

                    if (labelMap[label.name] == undefined) {
                      labelMap[label.name] = 1;
                    } else {
                      labelMap[label.name] += 1;
                    }

                    prList.push({
                      "value": \`<\${pull.html_url}|[\${label.name}] \${pull.title}>\`,
                      "short": false
                    });
                  });
                }

                let message;

                if (prList.length > 0) {
                  const keys = Array.from(labelMap.keys());
                  keys.sort();
                  message = {
                    "text": "ğŸš€ íŒ€ ì—¬ëŸ¬ë¶„! ë©‹ì§„ ìƒˆ PRë“¤ì´ ì—¬ëŸ¬ë¶„ì˜ ë§ˆë²• ê°™ì€ ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”! âœ¨",
                    "attachments": [
                      {
                        "color": "#36a64f",
                        "title": "ë¦¬ë·° ëŒ€ê¸° ì¤‘ì¸ PR ëª©ë¡",
                        "text": keys.map(key => `*${key}*: ${map.get(key)}`).join('\n'),
                        "fields": prList,
                        "footer": "í–‰ë³µí•œ ì½”ë”© ë˜ì„¸ìš”! ğŸ‰"
                      }
                    ]
                  };
                } else {
                  message = {
                    "text": "ğŸ‰ ìš°ì™€! ëŒ€ê¸° ì¤‘ì¸ PRì´ ì—†ì–´ìš”! ğŸ¥³",
                    "attachments": [
                      {
                        "color": "#FF4500",
                        "title": "ëª¨ë‘ ì™„ë£Œ!",
                        "text": "âœ¨ ëª¨ë‘ ì²˜ë¦¬ ì™„ë£Œ! ì´ì œ í¸íˆ ì‰¬ê±°ë‚˜ ë‹¤ìŒ ëŒ€ì‘ì„ ì‹œì‘í•´ë³¼ê¹Œìš”? ğŸš€",
                        "footer": "í›Œë¥­í•œ ì‘ì—… ê³„ì† ì´ì–´ê°€ì„¸ìš”! ğŸ’ª"
                      }
                    ]
                  };
                }

                await axios.post(process.env.SLACK_WEBHOOK_URL, message);
              } catch (error) {
                console.error(\`Error sending notifications: \${error.message}\`);
              }
            })();
          "
